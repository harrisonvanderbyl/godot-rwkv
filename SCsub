#!/usr/bin/env python

import os
Import('env')
Import('env_modules')
cwd = os.getcwd()
env_rwkv = env_modules.Clone()
# get cwd
cenv = os.getcwd()


if(env["PLATFORM"] != "win32"):
    

    env_rwkv.add_source_files(env.modules_sources, "*.cpp")
    
    # add -march=avx512
    env_rwkv.Append(CCFLAGS=['-march=haswell'])
    
    # -fopenmp  -flto  -fopenmp -funroll-loops -D_GLIBCXX_PARALLEL
    
    env_rwkv.Append(CCFLAGS=['-fexceptions'])
   
    # add -O3
    env_rwkv.Append(CCFLAGS=['-O3'])
    
    # add fast math
    env_rwkv.Append(CCFLAGS=['-ffast-math'])
    
    
    
    # add ./rwkv.hpp/include to include path
    # get current file location
    __file__ = env_rwkv.File('./SCsub').abspath
    path = os.path.dirname(os.path.abspath(__file__))
    env_rwkv.Append(CPPPATH=[path + "/rwkv.hpp/include"])

else:
    env_rwkv.Append(CCFLAGS=['/O2'])
    env_rwkv.Append(CCFLAGS=['/EHsc'])
    
    # add ./rwkv.hpp/include to include path
    # get current file location in scope of scons
    __file__ = env_rwkv.File('./SCsub').abspath
    path = os.path.dirname(os.path.abspath(__file__))
    env_rwkv.Append(CPPPATH=[path + "/rwkv.hpp/include"])
    
    # set avx512 
    env_rwkv.Append(CCFLAGS=['/arch:AVX2'])
        

    env_rwkv.add_source_files(env.modules_sources, "*.cpp")
