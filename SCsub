#!/usr/bin/env python

import os
Import('env')
Import('env_modules')
cwd = os.getcwd()
env_rwkv = env_modules.Clone()
# get cwd
cenv = os.getcwd()


if(env["PLATFORM"] != "win32"):



    env_rwkv.Prepend(
        LIBPATH=["/lib/x86_64-linux-gnu"])
   
    # add ./rwkv/include
    env_rwkv.Append(CPPPATH=[f'{cenv}/rwkv-cpp-cuda/include'])

    os.system(f'nvcc -c {cenv}/rwkv-cpp-cuda/include/rwkv/cuda/rwkv.cu --lib -o {cenv}/rwkv-cpp-cuda/include/rwkv/cuda/librwkv.a')

    env.Append(LIBS=['rwkv.a'])

    env.Append(LIBPATH=[cenv+'/rwkv-cpp-cuda/include/rwkv/cuda/'])

    # static link cudart
    env.Append(LIBS=['cudart_static'])

    env.Append(LIBPATH=['/usr/local/cuda/lib64/'])


    env_rwkv.Append(LINKFLAGS=['-Wl,-znodelete'])

    env.Append(LINKFLAGS=['-lrt'])

    env_rwkv.add_source_files(env.modules_sources, "*.cpp")

else:
    libend = ".windows.editor.x86_64.lib"
    prefix = ""
    os.system(f'copy "C:\\Program Files\\NVIDIA GPU Computing Toolkit\\CUDA\\v11.7\\lib\\x64\\cudart_static.lib" "{cenv}\\rwkv-cpp-cuda\\include\\rwkv\\cuda\\cudart_static.windows.editor.x86_64.lib"')

    env.Append(LIBS=['cudart_static'])

    env_rwkv.Append(CPPPATH=[f'{cenv}/rwkv-cpp-cuda/include'])

    os.system(f'nvcc -c {cenv}/rwkv-cpp-cuda/include/rwkv/cuda/rwkv.cu --lib -o {cenv}/rwkv-cpp-cuda/include/rwkv/cuda/{prefix}rwkvgodot{libend}')

    # add rwkv
    env.Append(LIBS=[f'rwkvgodot'])

    #add path to rwkv-cpp-cuda/include/rwkv/cuda/rwkv.a
    env.Append(LIBPATH=[cenv+'/rwkv-cpp-cuda/include/rwkv/cuda/'])


    env_rwkv.Append(LINKFLAGS=['-Wl,-znodelete'])


    env_rwkv.add_source_files(env.modules_sources, "*.cpp")
